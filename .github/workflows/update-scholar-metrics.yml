name: Update Google Scholar Metrics

on:
  # Run daily at 6 AM UTC (2 AM EST, 11 PM PST)
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on pushes to main branch that modify scholar script
  push:
    branches: [master, main, slim]
    paths: 
      - 'next-site/scripts/update-scholar-metrics.js'

jobs:
  update-metrics:
    name: Update Academic Metrics
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Allow the workflow to commit back to the repo
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'next-site/package-lock.json'
          
      - name: Install dependencies
        working-directory: next-site
        run: npm ci
        
      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libappindicator3-1 \
            libasound2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgbm1 \
            libgcc1 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            lsb-release \
            wget \
            xdg-utils
        
      - name: Run Scholar metrics update
        working-directory: next-site
        env:
          AUTO_COMMIT: 'true'
          CI: 'true'
        run: node scripts/update-scholar-metrics.js
        
      - name: Build updated site
        working-directory: next-site
        run: |
          npm run build
          cp -r out/* ../
          
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Google Scholar Bot"
          
          # Check if there are any changes
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -m "ü§ñ Auto-update: Google Scholar metrics $(date +'%Y-%m-%d %H:%M UTC')
            
            üìä Updated academic metrics from Google Scholar profile
            üîó Profile: https://scholar.google.com/citations?user=FkAGB3MAAAAJ&hl=en
            
            This update was automatically generated by GitHub Actions."
            git push origin HEAD:${{ github.ref_name }}
            echo "‚úÖ Successfully updated and deployed academic metrics!"
          else
            echo "‚ÑπÔ∏è No changes detected in Scholar metrics"
          fi
          
      - name: Trigger Pages deployment
        if: success()
        run: |
          echo "üöÄ Academic website updated with latest metrics!"
          echo "üåê Visit: https://junweizhang23.github.io/" 